<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classes</title>
    
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
    
        <!-- Preload critical resources with correct types -->
        <script src="/uv/uv.bundle.js"></script>
        <script src="/uv/uv.config.js"></script>
        
        <!-- Establish early connections to common game domains -->
        <link rel="preconnect" href="https://www.friv.com" crossorigin>
        <link rel="preconnect" href="https://poki.com" crossorigin>
        <link rel="preconnect" href="https://y8.com" crossorigin>
    
    <script>
        // Performance Optimization Mode
        const DEBUG_MODE = false; // Disable debugging for performance
        const PERFORMANCE_MODE = true;
        
        // Global variables for loading management
        let loadingAttempts = 0;
        const MAX_LOADING_ATTEMPTS = 3; // Reduced for faster fallback
        let loadTimeout;
        let analyticsErrorHandled = false;
        let uvConfigLoaded = false;
        let gameLoaded = false;
        
        // Helper function for debug logging
        function debugLog(...args) {
            if (DEBUG_MODE) {
                console.log("[GAME LOADER]", ...args);
            }
        }

        // Check if UV config is loaded
        function checkUVConfig() {
            if (window.__uv$config) {
                uvConfigLoaded = true;
                return true;
            }
            
            // Fallback - manually initialize UV if needed
            if (typeof window.UV !== 'undefined' && typeof window.UV.config !== 'undefined') {
                try {
                    window.__uv$config = window.UV.config;
                    uvConfigLoaded = true;
                    return true;
                } catch (e) {
                    console.error("Error setting UV config:", e);
                }
            }
            
            return false;
        }

        // Handle page refresh when using back button
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });

        // Preload navigation icons
        const preloadResources = [
            '/nav/home.png',
            '/nav/search.png',
            '/nav/apps.png',
            '/nav/fullscreenbutton.png',
            '/nav/reload.png',
            '/nav/flash.png',
            '/nav/chat_icon.png'
        ];

        preloadResources.forEach(resource => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'image';
            link.href = resource;
            document.head.appendChild(link);
        });

        // Register service worker with enhanced error handling
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swAllowedHostnames = ['localhost', '127.0.0.1'];
                
                const swPath = new URL('/uv/sw.js', window.location.origin).href;
                const swScope = new URL('/uv/', window.location.origin).href;

                if (location.protocol === 'https:' || swAllowedHostnames.includes(location.hostname)) {
                    navigator.serviceWorker.register(swPath, { scope: swScope })
                        .then(reg => {
                            console.log('Service Worker registered successfully with scope:', reg.scope);
                            
                            if (reg.active) {
                                reg.active.postMessage({ type: 'SKIP_WAITING' });
                            }
                            
                            // Handle updates
                            reg.onupdatefound = () => {
                                const installingWorker = reg.installing;
                                if (installingWorker) {
                                    installingWorker.onstatechange = () => {
                                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                            console.log('New service worker installed, reloading for clean state');
                                            // Optional: reload for clean state
                                            // window.location.reload();
                                        }
                                    };
                                }
                            };
                        })
                        .catch(error => {
                            console.error('SW registration failed:', error);
                            // Continue without service worker
                            showLoadingError("Service worker registration failed, but attempting to load game directly.");
                        });
                }
            }
        }

        // Function to show loading errors without breaking the entire experience
        function showLoadingError(message) {
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = message;
                loadingText.style.color = '#ff6666';
                
                // Create a retry button
                const retryBtn = document.createElement('button');
                retryBtn.textContent = 'Retry';
                retryBtn.style.marginTop = '15px';
                retryBtn.style.padding = '8px 16px';
                retryBtn.style.background = '#333';
                retryBtn.style.color = '#fff';
                retryBtn.style.border = 'none';
                retryBtn.style.borderRadius = '4px';
                retryBtn.style.cursor = 'pointer';
                
                retryBtn.onclick = () => {
                    loadingText.textContent = 'Loading Game...';
                    loadingText.style.color = '#fff';
                    retryBtn.remove();
                    loadingAttempts = 0;
                    initGame();
                };
                
                loadingText.parentNode.appendChild(retryBtn);
            }
        }

        // Override console.error to handle common errors that shouldn't block game loading
        const originalConsoleError = console.error;
        console.error = function(...args) {
            // Check if the error is from CrazyGames SDK or other common non-critical errors
            const errorText = args.join(' ');
            if (errorText.includes('CrazySDK is disabled') || 
                errorText.includes('401 (Unauthorized)') || 
                errorText.includes('Unauthorized') ||
                errorText.includes('Failed to send events') ||
                errorText.includes('Analytics') ||
                errorText.includes('tracking')) {
                
                // Only log once to reduce console spam
                if (!analyticsErrorHandled) {
                    analyticsErrorHandled = true;
                    console.log('Ignoring non-critical SDK/analytics error');
                }
                
                // Hide loading screen if it's been more than 3 seconds since these errors
                // often appear when the game is actually ready
                setTimeout(() => {
                    if (!gameLoaded) {
                        checkGameReady();
                    }
                }, 3000);
                
                return; // Don't pass these errors to the original console
            }
            
            // Call the original console.error for all other errors
            originalConsoleError.apply(console, args);
        };

                    // Check if game iframe appears ready and hide loading screen
        function checkGameReady() {
            const loadingScreen = document.getElementById('loadingScreen');
            const iframe = document.getElementById('gframe');
            
            if (loadingScreen && loadingScreen.style.visibility === 'visible' && iframe) {
                // Simplified check for performance
                if (iframe.src && iframe.src !== 'about:blank') {
                    // Force show the iframe for better performance
                    iframe.style.opacity = '1';
                    iframe.style.visibility = 'visible';
                    iframe.style.display = 'block';
                    
                    // Hide loading screen
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    
                    gameLoaded = true;
                    return true;
                }
            }
            return false;
        }

        // Initialize game from URL parameter
        function initGame() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const gameUrl = urlParams.get('game');
                
                if (!gameUrl) {
                    window.location.href = '/';
                    return;
                }

                // Simply load the game directly
                loadGameUrl(gameUrl);
            } catch (e) {
                console.error('Error initializing game:', e);
                // Try direct loading as a last resort
                const urlParams = new URLSearchParams(window.location.search);
                const gameUrl = urlParams.get('game');
                if (gameUrl) {
                    const iframe = document.getElementById('gframe');
                    if (iframe) iframe.src = gameUrl;
                }
            }
        }

        // Function to clear browser cache for the iframe
        function clearIframeCache() {
            const iframe = document.getElementById('gframe');
            if (iframe) {
                // Generate a unique URL parameter to break cache
                const cacheBuster = '?cache=' + Date.now();
                if (iframe.src.includes('?')) {
                    iframe.src = iframe.src.split('?')[0] + cacheBuster;
                } else {
                    iframe.src = iframe.src + cacheBuster;
                }
            }
        }

        // Main function to load the game
        function loadGameUrl(gameUrl, skipUV) {
            // Safety check for iframe
            const iframe = document.getElementById('gframe');
            const loadingScreen = document.getElementById('loadingScreen');
            const fallbackWrapper = document.getElementById('fallbackWrapper');
            
            if (!iframe) return;
            
            // Hide any fallback UI
            if (fallbackWrapper) {
                fallbackWrapper.style.display = 'none';
            }
            
            // Reset loaded state
            gameLoaded = false;
            
            // Show loading screen
            loadingScreen.style.opacity = '1';
            loadingScreen.style.visibility = 'visible';
            
            // Reset iframe
            iframe.style.display = 'block';
            iframe.style.opacity = '0';
            
            try {
                // Process the game URL
                const decodedUrl = decodeURIComponent(gameUrl);
                
                // Use simplest loading method for ALL URLs to avoid syntax errors
                iframe.src = 'about:blank';
                
                setTimeout(() => {
                    try {
                        // Just use direct loading for everything - most reliable
                        iframe.src = decodedUrl;
                        
                        // Force show after a delay
                        setTimeout(() => {
                            if (!gameLoaded) {
                                iframe.style.opacity = '1';
                                loadingScreen.style.opacity = '0';
                                loadingScreen.style.visibility = 'hidden';
                                gameLoaded = true;
                            }
                        }, 3000);
                    } catch (e) {
                        console.error('Error setting iframe source:', e);
                        iframe.style.opacity = '1';
                        loadingScreen.style.opacity = '0';
                        loadingScreen.style.visibility = 'hidden';
                    }
                }, 500);
                
                // Safety timeout
                clearTimeout(loadTimeout);
                loadTimeout = setTimeout(() => {
                    if (!gameLoaded) {
                        iframe.style.opacity = '1';
                        loadingScreen.style.opacity = '0';
                        loadingScreen.style.visibility = 'hidden';
                        gameLoaded = true;
                    }
                }, 6000);
                
            } catch (err) {
                console.error('Error in loadGameUrl:', err);
                // Force show after error
                iframe.style.opacity = '1';
                loadingScreen.style.opacity = '0';
                loadingScreen.style.visibility = 'hidden';
            }
        }

        // Set timeout for loading (extended from original)
            clearTimeout(loadTimeout);
            loadTimeout = setTimeout(() => {
                // Just force show the game after timeout
                if (!gameLoaded) {
                    iframe.style.opacity = '1';
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    gameLoaded = true;
                }
            }, 8000);  // Reduced from 30000 to 8000 for better performance

                            // Auto-hide loading screen after 15 seconds even without events
            // This helps with games that don't trigger proper load events
            const autoHideTimeout = setTimeout(() => {
                if (!gameLoaded && loadingScreen.style.visibility === 'visible') {
                    console.log('Auto-hiding loading screen after timeout');
                    
                    // Ensure we have content before hiding loading screen
                    if (iframe.src && iframe.src !== 'about:blank') {
                        // Show iframe first
                        iframe.style.display = 'block';
                        iframe.style.visibility = 'visible';
                        iframe.style.opacity = '1';
                        
                        // Then hide loading screen
                        setTimeout(() => {
                            loadingScreen.style.opacity = '0';
                            loadingScreen.style.visibility = 'hidden';
                        }, 100);
                        
                        clearTimeout(loadTimeout); // Clear the error timeout
                        gameLoaded = true;
                        
                        // Add fallback content if we're not sure the game loaded
                        checkIframeContentVisible();
                    } else {
                        // If we don't have a valid src, retry loading
                        console.warn('Auto-hide triggered but iframe has no content');
                        if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                            loadingAttempts++;
                            const urlParams = new URLSearchParams(window.location.search);
                            const gameUrl = urlParams.get('game');
                            if (gameUrl) {
                                loadGameUrl(gameUrl, loadingAttempts % 2 === 0);
                            }
                        } else {
                            // Show error if we've tried too many times
                            showLoadingError('Game content not loading properly. Please try a different browser or game.');
                        }
                    }
                }
            }, 15000); // 15 seconds timeout
            
            // Function to check if iframe content is visible and add fallback if needed
            function checkIframeContentVisible() {
                setTimeout(() => {
                    // If the game still appears invisible, try to add a minimal fallback
                    const computedStyle = window.getComputedStyle(iframe);
                    if (computedStyle.opacity === '0' || computedStyle.visibility === 'hidden') {
                        console.warn('Game content may not be visible, applying fallback visibility');
                        iframe.style.opacity = '1';
                        iframe.style.visibility = 'visible';
                        iframe.style.display = 'block';
                    }
                }, 2000);
            }

            // Listen for any activity in the iframe as a sign it's loaded
            iframe.onload = () => {
                clearTimeout(loadTimeout);
                console.log('Iframe onload triggered');
                
                // Check if iframe has actual content
                const hasContent = iframe.src && iframe.src !== 'about:blank';
                console.log('Iframe has content:', hasContent, 'Source:', iframe.src);
                
                if (!hasContent) {
                    console.warn('Iframe loaded but appears to have no content');
                    return;
                }
                
                // Give a short delay to let the game initialize
                setTimeout(() => {
                    // Set iframe visible first
                    iframe.style.opacity = '1';
                    iframe.style.visibility = 'visible';
                    iframe.style.display = 'block';
                    
                    // Then hide loading screen
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    
                    clearTimeout(autoHideTimeout);
                    console.log('Game loaded successfully');
                    gameLoaded = true;
                    
                    // Double check visibility after a moment
                    setTimeout(() => {
                        if (iframe.style.opacity !== '1') {
                            console.log('Enforcing iframe visibility');
                            iframe.style.opacity = '1';
                        }
                    }, 500);
                }, 1000);
            };

            // Handle load errors
            iframe.onerror = (error) => {
                clearTimeout(loadTimeout);
                console.log('Game loading failed with error:', error);
                
                // Try loading again if under max attempts
                if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                    loadingAttempts++;
                    console.log(`Retrying game load after error (Attempt ${loadingAttempts + 1})`);
                    
                    // If error occurs, try the opposite of current UV setting
                    loadGameUrl(gameUrl, !skipUV);
                } else {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    iframe.style.opacity = '1';
                    clearTimeout(autoHideTimeout);
                    showLoadingError('Failed to load game. Please try a different browser or game.');
                }
            };

                            // Check iframe content periodically
            const contentCheckInterval = setInterval(() => {
                if (checkGameReady() || loadingScreen.style.visibility !== 'visible') {
                    clearInterval(contentCheckInterval);
                }
            }, 1000);
            
            // Fallback - show fallback UI if game doesn't appear after significant time
            setTimeout(() => {
                const iframe = document.getElementById('gframe');
                if (iframe && iframe.src && iframe.src !== 'about:blank' && !gameLoaded) {
                    debugLog('Game did not become visible after extended timeout, showing fallback options');
                    
                    const fallbackWrapper = document.getElementById('fallbackWrapper');
                    if (fallbackWrapper) {
                        fallbackWrapper.style.display = 'flex';
                    }
                }
            }, 20000); // 20 seconds

            try {
                // Process the game URL
                const decodedUrl = decodeURIComponent(gameUrl);
                console.log('Decoded game URL:', decodedUrl);
                
                // Check if we need special handling for this domain
                const needsSpecialHandling = tryDirectLoad(decodedUrl);
                
                // Don't re-encode URLs that are already in UV format
                if (decodedUrl.startsWith('/uv/') || decodedUrl.startsWith('/service/')) {
                    console.log('URL appears to be already in UV format, using directly:', decodedUrl);
                    
                    // For special domains, try a more direct approach first
                    if (needsSpecialHandling && loadingAttempts > 0) {
                        // Try to extract the actual URL from the UV format
                        try {
                            const encodedPart = decodedUrl.replace('/uv/service/', '');
                            const actualUrl = atob(encodedPart);
                            console.log('Using special handling - extracted URL:', actualUrl);
                            
                            // For Friv games specifically, try a different approach
                            if (actualUrl.includes('friv.com')) {
                                const directUrl = '/uv/service/' + encodedPart;
                                iframe.src = directUrl;
                                console.log('Set direct UV path for Friv game:', directUrl);
                                
                                // Create a container iframe if needed
                                if (loadingAttempts > 1) {
                                    console.log('Trying containment approach for Friv game');
                                    const tempIframe = document.createElement('iframe');
                                    tempIframe.style.display = 'none';
                                    document.body.appendChild(tempIframe);
                                    
                                    try {
                                        const tempDoc = tempIframe.contentDocument || tempIframe.contentWindow.document;
                                        tempDoc.open();
                                        tempDoc.write(`
                                            <!DOCTYPE html>
                                            <html>
                                            <head><title>Game Frame</title></head>
                                            <body style="margin:0;padding:0;overflow:hidden;">
                                                <iframe src="${directUrl}" style="width:100%;height:100%;border:none;" allowfullscreen></iframe>
                                            </body>
                                            </html>
                                        `);
                                        tempDoc.close();
                                        
                                        // Set our main iframe to this content
                                        setTimeout(() => {
                                            iframe.src = 'about:blank';
                                            setTimeout(() => {
                                                iframe.src = URL.createObjectURL(new Blob([tempDoc.documentElement.outerHTML], {type: 'text/html'}));
                                                document.body.removeChild(tempIframe);
                                            }, 200);
                                        }, 200);
                                        
                                        return; // Skip the regular assignment below
                                    } catch (e) {
                                        console.log('Container approach failed:', e);
                                        document.body.removeChild(tempIframe);
                                    }
                                }
                            }
                        } catch (e) {
                            console.log('Special handling extraction failed:', e);
                        }
                    }
                    
                    // Default approach - use direct URL
                    iframe.src = decodedUrl;
                } 
                // Handle bare URLs (not starting with http or https)
                else if (!decodedUrl.startsWith('http://') && !decodedUrl.startsWith('https://')) {
                    console.log('URL is not an absolute URL, using directly:', decodedUrl);
                    iframe.src = decodedUrl;
                }
                // Handle regular URLs that need encoding
                else if (window.__uv$config && !skipUV) {
                    console.log('Encoding URL through UV proxy:', decodedUrl);
                    const encodedUrl = window.__uv$config.prefix + window.__uv$config.encodeUrl(decodedUrl);
                    console.log('Encoded URL:', encodedUrl);
                    iframe.src = encodedUrl;
                } else {
                    // Direct loading without UV as fallback
                    console.log('UV config not available or skipped, using URL directly:', decodedUrl);
                    iframe.src = decodedUrl;
                }
                
                // Add iframe content check listeners
                iframe.addEventListener('load', function() {
                    // Additional check for successful load
                    console.log('Additional load listener triggered');
                    setTimeout(checkGameReady, 1000);
                });
                
                // Special handling for service worker errors
                window.addEventListener('unhandledrejection', function(event) {
                    console.warn('Unhandled promise rejection:', event.reason);
                    
                    // If it's a service worker error and we're still loading
                    if (event.reason && event.reason.message && 
                        event.reason.message.includes('URL') && 
                        loadingScreen.style.visibility === 'visible') {
                        
                        console.log('Detected service worker URL error, attempting recovery');
                        
                        // Try direct loading if we haven't already
                        if (!skipUV && loadingAttempts < MAX_LOADING_ATTEMPTS) {
                            loadingAttempts++;
                            loadGameUrl(gameUrl, true); // Skip UV this time
                        }
                    }
                });
            } catch (error) {
                clearTimeout(loadTimeout);
                clearTimeout(autoHideTimeout);
                loadingScreen.style.opacity = '0';
                loadingScreen.style.visibility = 'hidden';
                console.error('URL processing error:', error);
                showLoadingError('Failed to process game URL. Please try again with a different game.');
            }
        }
        
        // Initialize service worker when page loads
        window.addEventListener('load', () => {
            registerServiceWorker();
        });
        
        // Initialize the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Start loading immediately for better performance
            initGame();
            
            // Add performance optimization hints
            if (PERFORMANCE_MODE) {
                // Add preconnect for common game domains
                const domains = [
                    'friv.com', 'www.friv.com',
                    'poki.com', 'www.poki.com',
                    'y8.com', 'www.y8.com'
                ];
                
                domains.forEach(domain => {
                    const link = document.createElement('link');
                    link.rel = 'preconnect';
                    link.href = `https://${domain}`;
                    link.crossOrigin = 'anonymous';
                    document.head.appendChild(link);
                });
                
                // Set browser hint to prioritize performance
                const meta = document.createElement('meta');
                meta.httpEquiv = 'Page-Speed';
                meta.content = 'High';
                document.head.appendChild(meta);
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: system-ui, sans-serif;
            position: relative;
        }

        .header {
            position: fixed;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            left: 0;
            padding: 1rem;
            top: 0;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header a {
            margin: 0 1.5rem;
        }

        .home_bttn {
            height: 3vh;
            width: 3vh;
        }

        .game_container {
            background: #000;
            width: 80%;
            max-width: 1000px;
            height: 70vh;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            z-index: 2;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 36px);
            background: rgba(0, 0, 0, 0.9); /* Slightly transparent for better perceived loading */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5;
            border-radius: 10px 10px 0 0;
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out; /* Faster transition */
            visibility: visible;
            will-change: opacity, visibility; /* Performance optimization */
            backdrop-filter: blur(3px); /* Adds depth without heavy performance cost */
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #fff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .game_iframe {
            width: 100%;
            height: calc(100% - 36px);
            border: none;
            border-radius: 10px 10px 0 0;
            background-color: #000;
            opacity: 0;
            transition: opacity 0.2s ease-in; /* Faster transition */
            position: relative;
            z-index: 1;
            display: block;
            will-change: opacity; /* Optimize for animations */
            transform: translateZ(0); /* Force GPU acceleration */
        }

        .footer {
            height: 36px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .footer button {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .footer button img {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/"><img src="/nav/home.png" class="home_bttn" alt="Home"></a>
        <a href="/ta"><img src="/nav/search.png" class="home_bttn" alt="Search"></a>
        <a href="/app"><img src="/nav/apps.png" class="home_bttn" alt="Apps"></a>
    </header>

    <div class="game_container">
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Game...</div>
        </div>
        <!-- iframe for game content -->
        <iframe class="game_iframe" id="gframe" allow="fullscreen; autoplay; clipboard-write; clipboard-read; microphone; camera; accelerometer; gyroscope; payment"></iframe>
        <div class="footer">
            <button onclick="toggleFullScreen()" title="Fullscreen">
                <img src="/nav/fullscreenbutton.png" alt="Fullscreen">
            </button>
            <button onclick="reloadGame()" title="Reload Game">
                <img src="/nav/reload.png" alt="Reload">
            </button>
            <button onclick="toggleFlashlight()" title="Flashlight">
                <img src="/nav/flash.png" alt="Flashlight">
            </button>
            <button onclick="toggleChat()" title="Chat">
                <img src="/nav/chat_icon.png" alt="Chat">
            </button>
        </div>
    </div>

    <script>
        function reloadGame() {
            try {
                const iframe = document.getElementById('gframe');
                const loadingScreen = document.getElementById('loadingScreen');
                const fallbackWrapper = document.getElementById('fallbackWrapper');
                
                // Hide any visible fallback
                if (fallbackWrapper) {
                    fallbackWrapper.style.display = 'none';
                }
                
                // Reset state variables
                loadingAttempts = 0;
                analyticsErrorHandled = false;
                gameLoaded = false;
                
                // Show loading screen
                loadingScreen.style.opacity = '1';
                loadingScreen.style.visibility = 'visible';
                iframe.style.opacity = '0';
                
                // Get current or original URL
                let gameUrl;
                
                if (iframe.src && iframe.src !== 'about:blank') {
                    gameUrl = iframe.src;
                } else {
                    const urlParams = new URLSearchParams(window.location.search);
                    gameUrl = urlParams.get('game');
                }
                
                if (!gameUrl) {
                    showLoadingError('No game URL found. Please return to the home page.');
                    return;
                }
                
                // Reset iframe
                iframe.src = 'about:blank';
                
                // Try to load with the most basic approach for better compatibility
                setTimeout(() => {
                    try {
                        iframe.src = gameUrl;
                        
                        // Force show after a delay
                        setTimeout(() => {
                            iframe.style.opacity = '1';
                            loadingScreen.style.opacity = '0';
                            loadingScreen.style.visibility = 'hidden';
                        }, 3000);
                    } catch (error) {
                        console.error('Error reloading game:', error);
                        showLoadingError('Error reloading game. Please try a different game.');
                    }
                }, 500);
            } catch (error) {
                console.error('Critical error in reload:', error);
            }
        }

        function toggleFullScreen() {
            const gameContainer = document.querySelector('.game_container');
            const iframe = document.getElementById('gframe');
            const target = iframe; // Target the iframe for fullscreen
            
            try {
                if (!document.fullscreenElement && 
                    !document.webkitFullscreenElement && 
                    !document.msFullscreenElement) {
                    
                    // Try different fullscreen methods
                    if (target.requestFullscreen) {
                        target.requestFullscreen();
                    } else if (target.webkitRequestFullscreen) {
                        target.webkitRequestFullscreen();
                    } else if (target.msRequestFullscreen) {
                        target.msRequestFullscreen();
                    } else if (target.mozRequestFullScreen) {
                        target.mozRequestFullScreen();
                    }
                    
                    // Also try to make the iframe request fullscreen internally
                    try {
                        iframe.contentWindow.postMessage('requestFullscreen', '*');
                    } catch (e) {
                        // Ignore cross-origin errors
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    }
                }
            } catch (err) {
                console.error('Fullscreen error:', err);
                alert('Fullscreen mode is not supported in your browser or for this game');
            }
        }

        // Flashlight feature - toggles a dimmer overlay
        function toggleFlashlight() {
            let dimmer = document.getElementById('dimmer');
            
            if (!dimmer) {
                // Create the dimmer if it doesn't exist
                dimmer = document.createElement('div');
                dimmer.id = 'dimmer';
                dimmer.style.position = 'fixed';
                dimmer.style.top = '0';
                dimmer.style.left = '0';
                dimmer.style.width = '100%';
                dimmer.style.height = '100%';
                dimmer.style.background = 'rgba(0, 0, 0, 0.7)';
                dimmer.style.zIndex = '1';
                dimmer.style.transition = 'opacity 0.3s ease';
                document.body.appendChild(dimmer);
            } else {
                // Toggle visibility
                dimmer.style.display = dimmer.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Chat feature placeholder
        function toggleChat() {
            alert('Chat feature coming soon!');
        }
    </script>

    <!-- Removed reference to favicon-handler.js to simplify -->
</body>
</html>
