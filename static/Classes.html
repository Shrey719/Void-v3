<!DOCTYPE html>
<html>
<!-- Previous head content remains the same until the style section -->
<head>
    <title>Classes</title>

    <style>
        /* Previous styles remain the same */

        /* Updated Ad Container Styles */
        #adContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: rgba(0,0,0,0.9);
            display: none;
        }

        #adVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #skipButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            z-index: 2001;
            display: none;
        }

        #closeAdButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
            z-index: 2001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <!-- Previous head content remains the same -->
</head>
<body>
    <!-- Previous body content remains the same until the script section -->

    <script>
        // Previous game-related functions remain the same

        // Updated VAST Ad Handler Implementation
        class VastAdHandler {
            constructor() {
                this.adContainer = null;
                this.videoPlayer = null;
                this.skipButton = null;
                this.vastUrl = 'https://sophisticatedappearance.com/dVm/FNz/d.GgNZvPZBG/UB/TeymR9/ueZXUFl/k/PtTwUk3GN/DCkAxjOMT/UNtbN/TNcw0uOTTdEG5rNFiiZ/sPaBWj1ApqdEDi0fxQ';
                this.isAdPlaying = false;
            }

            initialize() {
                // Create ad container
                this.adContainer = document.createElement('div');
                this.adContainer.id = 'adContainer';
                document.body.appendChild(this.adContainer);

                // Create video element
                this.videoPlayer = document.createElement('video');
                this.videoPlayer.id = 'adVideo';
                this.videoPlayer.setAttribute('playsinline', '');
                this.videoPlayer.setAttribute('webkit-playsinline', '');
                this.videoPlayer.setAttribute('muted', 'true'); // Start muted to allow autoplay
                this.adContainer.appendChild(this.videoPlayer);

                // Add skip button
                this.skipButton = document.createElement('button');
                this.skipButton.id = 'skipButton';
                this.skipButton.textContent = 'Skip Ad';
                this.skipButton.onclick = () => this.closeAd();
                this.adContainer.appendChild(this.skipButton);

                // Add close button
                const closeButton = document.createElement('button');
                closeButton.id = 'closeAdButton';
                closeButton.innerHTML = 'Ã—';
                closeButton.onclick = () => this.closeAd();
                this.adContainer.appendChild(closeButton);

                // Add video event listeners
                this.videoPlayer.addEventListener('timeupdate', () => {
                    if (this.videoPlayer.currentTime >= 5 && this.skipButton) {
                        this.skipButton.style.display = 'block';
                    }
                });

                // Add click to unmute
                this.videoPlayer.addEventListener('click', () => {
                    if (this.videoPlayer.muted) {
                        this.videoPlayer.muted = false;
                    }
                });
            }

            async loadVastXml() {
                try {
                    const response = await fetch(this.vastUrl);
                    const vastXml = await response.text();
                    const parser = new DOMParser();
                    return parser.parseFromString(vastXml, 'text/xml');
                } catch (error) {
                    console.error('Error loading VAST XML:', error);
                    return null;
                }
            }

            getMediaFiles(xmlDoc) {
                const mediaFiles = xmlDoc.getElementsByTagName('MediaFile');
                const sources = [];
                
                for (let mediaFile of mediaFiles) {
                    const type = mediaFile.getAttribute('type');
                    const url = mediaFile.textContent.trim();
                    sources.push({ type, url });
                }
                
                return sources;
            }

            trackImpression(xmlDoc) {
                const impressionUrls = xmlDoc.getElementsByTagName('Impression');
                for (let impression of impressionUrls) {
                    const url = impression.textContent.trim();
                    new Image().src = url;
                }
            }

            trackEvent(xmlDoc, eventName) {
                const trackingEvents = xmlDoc.getElementsByTagName('Tracking');
                for (let event of trackingEvents) {
                    if (event.getAttribute('event') === eventName) {
                        const url = event.textContent.trim();
                        new Image().src = url;
                    }
                }
            }

            handleClick(xmlDoc) {
                const clickThrough = xmlDoc.getElementsByTagName('ClickThrough')[0];
                if (clickThrough) {
                    const url = clickThrough.textContent.trim();
                    window.open(url, '_blank');
                }
            }

            closeAd() {
                if (this.isAdPlaying) {
                    this.videoPlayer.pause();
                    this.adContainer.style.display = 'none';
                    this.isAdPlaying = false;
                    this.skipButton.style.display = 'none';
                }
            }

            async playAd() {
                if (this.isAdPlaying) return;

                const vastXml = await this.loadVastXml();
                if (!vastXml) return;

                const mediaFiles = this.getMediaFiles(vastXml);
                if (mediaFiles.length === 0) return;

                // Sort media files to prefer MP4 format
                const sortedMediaFiles = mediaFiles.sort((a, b) => {
                    if (a.type === 'video/mp4') return -1;
                    if (b.type === 'video/mp4') return 1;
                    return 0;
                });

                // Clear existing sources
                this.videoPlayer.innerHTML = '';
                
                // Add new sources
                sortedMediaFiles.forEach(({type, url}) => {
                    const source = document.createElement('source');
                    source.type = type;
                    source.src = url;
                    this.videoPlayer.appendChild(source);
                });

                // Show ad container
                this.adContainer.style.display = 'block';
                this.isAdPlaying = true;

                // Track impression
                this.trackImpression(vastXml);

                // Set up click handling
                this.videoPlayer.onclick = () => this.handleClick(vastXml);
                
                // Track start event
                this.videoPlayer.onplay = () => this.trackEvent(vastXml, 'start');

                // Attempt to play
                try {
                    await this.videoPlayer.play();
                    this.videoPlayer.muted = true; // Ensure muted start
                } catch (error) {
                    console.error('Error playing video:', error);
                    // If autoplay fails, show a play button
                    const playButton = document.createElement('button');
                    playButton.textContent = 'Play Ad';
                    playButton.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; font-size: 20px; cursor: pointer;';
                    playButton.onclick = async () => {
                        try {
                            await this.videoPlayer.play();
                            playButton.remove();
                        } catch (e) {
                            console.error('Error on manual play:', e);
                        }
                    };
                    this.adContainer.appendChild(playButton);
                }
            }
        }

        // Initialize VAST Ad Handler
        const vastAdHandler = new VastAdHandler();

        // Load external resources after main content
        window.addEventListener('load', () => {
            // Initialize ad handler
            vastAdHandler.initialize();
            
            // Play ad immediately after initialization
            vastAdHandler.playAd();

            // Previous event listeners remain the same
        });
    </script>
</body>
</html>
