<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classes</title>
    
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
    
    <!-- UV Proxy Scripts - Preload for faster initialization -->
    <link rel="preload" href="/uv/uv.bundle.js" as="script">
    <link rel="preload" href="/uv/uv.config.js" as="script">
    <script src="/uv/uv.bundle.js" defer></script>
    <script src="/uv/uv.config.js" defer></script>
    
    <script>
        // Global variables for loading management
        let loadingAttempts = 0;
        const MAX_LOADING_ATTEMPTS = 5; // Increased from 3
        let loadTimeout;
        let analyticsErrorHandled = false;
        let uvConfigLoaded = false;
        let gameLoaded = false;

        // Check if UV config is loaded
        function checkUVConfig() {
            if (window.__uv$config) {
                uvConfigLoaded = true;
                return true;
            }
            return false;
        }

        // Handle page refresh when using back button
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });

        // Preload navigation icons
        const preloadResources = [
            '/nav/home.png',
            '/nav/search.png',
            '/nav/apps.png',
            '/nav/fullscreenbutton.png',
            '/nav/reload.png',
            '/nav/flash.png',
            '/nav/chat_icon.png'
        ];

        preloadResources.forEach(resource => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'image';
            link.href = resource;
            document.head.appendChild(link);
        });

        // Register service worker with enhanced error handling
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swAllowedHostnames = ['localhost', '127.0.0.1'];
                
                const swPath = new URL('/uv/sw.js', window.location.origin).href;
                const swScope = new URL('/uv/', window.location.origin).href;

                if (location.protocol === 'https:' || swAllowedHostnames.includes(location.hostname)) {
                    navigator.serviceWorker.register(swPath, { scope: swScope })
                        .then(reg => {
                            console.log('Service Worker registered successfully with scope:', reg.scope);
                            
                            if (reg.active) {
                                reg.active.postMessage({ type: 'SKIP_WAITING' });
                            }
                            
                            // Handle updates
                            reg.onupdatefound = () => {
                                const installingWorker = reg.installing;
                                if (installingWorker) {
                                    installingWorker.onstatechange = () => {
                                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                            console.log('New service worker installed, reloading for clean state');
                                            // Optional: reload for clean state
                                            // window.location.reload();
                                        }
                                    };
                                }
                            };
                        })
                        .catch(error => {
                            console.error('SW registration failed:', error);
                            // Continue without service worker
                            showLoadingError("Service worker registration failed, but attempting to load game directly.");
                        });
                }
            }
        }

        // Function to show loading errors without breaking the entire experience
        function showLoadingError(message) {
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = message;
                loadingText.style.color = '#ff6666';
                
                // Create a retry button
                const retryBtn = document.createElement('button');
                retryBtn.textContent = 'Retry';
                retryBtn.style.marginTop = '15px';
                retryBtn.style.padding = '8px 16px';
                retryBtn.style.background = '#333';
                retryBtn.style.color = '#fff';
                retryBtn.style.border = 'none';
                retryBtn.style.borderRadius = '4px';
                retryBtn.style.cursor = 'pointer';
                
                retryBtn.onclick = () => {
                    loadingText.textContent = 'Loading Game...';
                    loadingText.style.color = '#fff';
                    retryBtn.remove();
                    loadingAttempts = 0;
                    initGame();
                };
                
                loadingText.parentNode.appendChild(retryBtn);
            }
        }

        // Override console.error to handle common errors that shouldn't block game loading
        const originalConsoleError = console.error;
        console.error = function(...args) {
            // Check if the error is from CrazyGames SDK or other common non-critical errors
            const errorText = args.join(' ');
            if (errorText.includes('CrazySDK is disabled') || 
                errorText.includes('401 (Unauthorized)') || 
                errorText.includes('Unauthorized') ||
                errorText.includes('Failed to send events') ||
                errorText.includes('Analytics') ||
                errorText.includes('tracking')) {
                
                // Only log once to reduce console spam
                if (!analyticsErrorHandled) {
                    analyticsErrorHandled = true;
                    console.log('Ignoring non-critical SDK/analytics error');
                }
                
                // Hide loading screen if it's been more than 3 seconds since these errors
                // often appear when the game is actually ready
                setTimeout(() => {
                    if (!gameLoaded) {
                        checkGameReady();
                    }
                }, 3000);
                
                return; // Don't pass these errors to the original console
            }
            
            // Call the original console.error for all other errors
            originalConsoleError.apply(console, args);
        };

        // Check if game iframe appears ready and hide loading screen
        function checkGameReady() {
            const loadingScreen = document.getElementById('loadingScreen');
            const iframe = document.getElementById('gframe');
            
            if (loadingScreen && loadingScreen.style.visibility === 'visible' && iframe) {
                try {
                    // Attempt to check if iframe has loaded content
                    let iframeLoaded = false;
                    
                    try {
                        // This might throw CORS errors, which is normal
                        iframeLoaded = iframe.contentWindow && 
                            (iframe.contentWindow.document.readyState === 'complete' || 
                             iframe.contentWindow.document.readyState === 'interactive');
                    } catch (e) {
                        // CORS error - expected behavior
                        // If we've been loading for a while, assume the iframe may be ready
                        if (loadingAttempts > 1) {
                            iframeLoaded = true;
                        }
                    }
                    
                    // Hide loading screen if content appears to be loaded
                    if (iframeLoaded || iframe.complete) {
                        console.log('Game appears ready - hiding loading screen');
                        loadingScreen.style.opacity = '0';
                        loadingScreen.style.visibility = 'hidden';
                        iframe.style.opacity = '1';
                        gameLoaded = true;
                        return true;
                    }
                } catch (error) {
                    console.log('Error checking iframe readiness:', error);
                }
            }
            return false;
        }

        // Initialize game from URL parameter
        function initGame() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameUrl = urlParams.get('game');
            
            if (!gameUrl) {
                window.location.href = '/';
                return;
            }

            // Check if UV config is loaded or wait for it
            if (checkUVConfig()) {
                loadGameUrl(gameUrl);
            } else {
                console.log('Waiting for UV config to load...');
                let uvCheckAttempts = 0;
                const uvCheckInterval = setInterval(() => {
                    uvCheckAttempts++;
                    if (checkUVConfig()) {
                        clearInterval(uvCheckInterval);
                        loadGameUrl(gameUrl);
                    } else if (uvCheckAttempts >= 10) {
                        // After 5 seconds, try loading directly without UV if needed
                        clearInterval(uvCheckInterval);
                        console.warn('UV config not loaded after 10 attempts, trying direct load');
                        loadGameUrl(gameUrl, true);
                    }
                }, 500); // Check every 500ms
            }
        }

        // Function to clear browser cache for the iframe
        function clearIframeCache() {
            const iframe = document.getElementById('gframe');
            if (iframe) {
                // Generate a unique URL parameter to break cache
                const cacheBuster = '?cache=' + Date.now();
                if (iframe.src.includes('?')) {
                    iframe.src = iframe.src.split('?')[0] + cacheBuster;
                } else {
                    iframe.src = iframe.src + cacheBuster;
                }
            }
        }

        // Main function to load the game
        function loadGameUrl(gameUrl, skipUV) {
            const iframe = document.getElementById('gframe');
            const loadingScreen = document.getElementById('loadingScreen');
            
            if (!iframe) return;
            
            // Reset loaded state
            gameLoaded = false;
            
            // Show loading screen
            loadingScreen.style.opacity = '1';
            loadingScreen.style.visibility = 'visible';
            iframe.style.opacity = '0';

            // Update loading text
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = 'Loading Game...';
                loadingText.style.color = '#fff';
            }

            // Set timeout for loading (extended from original)
            clearTimeout(loadTimeout);
            loadTimeout = setTimeout(() => {
                console.log(`Game loading attempt ${loadingAttempts + 1} timed out`);
                
                // Try loading again if under max attempts
                if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                    loadingAttempts++;
                    console.log(`Retrying game load (Attempt ${loadingAttempts + 1})`);
                    
                    // If multiple attempts failed, try toggling UV usage
                    const useUV = loadingAttempts % 2 === 0 ? !skipUV : skipUV;
                    
                    // Try clearing cache on later attempts
                    if (loadingAttempts > 2) {
                        clearIframeCache();
                    }
                    
                    loadGameUrl(gameUrl, useUV);
                } else {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    iframe.style.opacity = '1';
                    iframe.src = 'about:blank';
                    showLoadingError('Game loading failed after multiple attempts. Try refreshing or using a different browser.');
                }
            }, 30000);  // 30 seconds timeout (increased from 25)

            // Auto-hide loading screen after 15 seconds even without events
            // This helps with games that don't trigger proper load events
            const autoHideTimeout = setTimeout(() => {
                if (!gameLoaded && loadingScreen.style.visibility === 'visible') {
                    console.log('Auto-hiding loading screen after timeout');
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    iframe.style.opacity = '1';
                    clearTimeout(loadTimeout); // Clear the error timeout
                    gameLoaded = true;
                }
            }, 15000); // Increased from 12000

            // Listen for any activity in the iframe as a sign it's loaded
            iframe.onload = () => {
                clearTimeout(loadTimeout);
                console.log('Iframe onload triggered');
                
                // Give a short delay to let the game initialize
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    iframe.style.opacity = '1';
                    clearTimeout(autoHideTimeout);
                    console.log('Game loaded successfully');
                    gameLoaded = true;
                }, 1000);
            };

            // Handle load errors
            iframe.onerror = (error) => {
                clearTimeout(loadTimeout);
                console.log('Game loading failed with error:', error);
                
                // Try loading again if under max attempts
                if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                    loadingAttempts++;
                    console.log(`Retrying game load after error (Attempt ${loadingAttempts + 1})`);
                    
                    // If error occurs, try the opposite of current UV setting
                    loadGameUrl(gameUrl, !skipUV);
                } else {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.visibility = 'hidden';
                    iframe.style.opacity = '1';
                    clearTimeout(autoHideTimeout);
                    showLoadingError('Failed to load game. Please try a different browser or game.');
                }
            };

            // Check iframe content periodically
            const contentCheckInterval = setInterval(() => {
                if (checkGameReady() || loadingScreen.style.visibility !== 'visible') {
                    clearInterval(contentCheckInterval);
                }
            }, 1000);

            try {
                // Process the game URL
                const decodedUrl = decodeURIComponent(gameUrl);
                console.log('Decoded game URL:', decodedUrl);
                
                // Don't re-encode URLs that are already in UV format
                if (decodedUrl.startsWith('/uv/') || decodedUrl.startsWith('/service/')) {
                    console.log('URL appears to be already in UV format, using directly:', decodedUrl);
                    iframe.src = decodedUrl;
                } 
                // Handle bare URLs (not starting with http or https)
                else if (!decodedUrl.startsWith('http://') && !decodedUrl.startsWith('https://')) {
                    console.log('URL is not an absolute URL, using directly:', decodedUrl);
                    iframe.src = decodedUrl;
                }
                // Handle regular URLs that need encoding
                else if (window.__uv$config && !skipUV) {
                    console.log('Encoding URL through UV proxy:', decodedUrl);
                    const encodedUrl = window.__uv$config.prefix + window.__uv$config.encodeUrl(decodedUrl);
                    console.log('Encoded URL:', encodedUrl);
                    iframe.src = encodedUrl;
                } else {
                    // Direct loading without UV as fallback
                    console.log('UV config not available or skipped, using URL directly:', decodedUrl);
                    iframe.src = decodedUrl;
                }
                
                // Add iframe content check listeners
                iframe.addEventListener('load', function() {
                    // Additional check for successful load
                    console.log('Additional load listener triggered');
                    setTimeout(checkGameReady, 1000);
                });
            } catch (error) {
                clearTimeout(loadTimeout);
                clearTimeout(autoHideTimeout);
                loadingScreen.style.opacity = '0';
                loadingScreen.style.visibility = 'hidden';
                console.error('URL processing error:', error);
                showLoadingError('Failed to process game URL. Please try again with a different game.');
            }
        }
        
        // Initialize service worker when page loads
        window.addEventListener('load', () => {
            registerServiceWorker();
        });
        
        // Initialize the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initGame, 200); // Increased delay for better DOM readiness
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: system-ui, sans-serif;
            position: relative;
        }

        .header {
            position: fixed;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            left: 0;
            padding: 1rem;
            top: 0;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header a {
            margin: 0 1.5rem;
        }

        .home_bttn {
            height: 3vh;
            width: 3vh;
        }

        .game_container {
            background: #000;
            width: 80%;
            max-width: 1000px;
            height: 70vh;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            z-index: 2;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 36px);
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5;
            border-radius: 10px 10px 0 0;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #fff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .game_iframe {
            width: 100%;
            height: calc(100% - 36px);
            border: none;
            border-radius: 10px 10px 0 0;
            background-color: #000;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .footer {
            height: 36px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .footer button {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .footer button img {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/"><img src="/nav/home.png" class="home_bttn" alt="Home"></a>
        <a href="/ta"><img src="/nav/search.png" class="home_bttn" alt="Search"></a>
        <a href="/app"><img src="/nav/apps.png" class="home_bttn" alt="Apps"></a>
    </header>

    <div class="game_container">
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Game...</div>
        </div>
        <!-- iframe for game content -->
        <iframe class="game_iframe" id="gframe" allow="fullscreen; autoplay; clipboard-write; clipboard-read; microphone; camera; accelerometer; gyroscope; payment"></iframe>
        <div class="footer">
            <button onclick="toggleFullScreen()" title="Fullscreen">
                <img src="/nav/fullscreenbutton.png" alt="Fullscreen">
            </button>
            <button onclick="reloadGame()" title="Reload Game">
                <img src="/nav/reload.png" alt="Reload">
            </button>
            <button onclick="toggleFlashlight()" title="Flashlight">
                <img src="/nav/flash.png" alt="Flashlight">
            </button>
            <button onclick="toggleChat()" title="Chat">
                <img src="/nav/chat_icon.png" alt="Chat">
            </button>
        </div>
    </div>

    <script>
        function reloadGame() {
            const iframe = document.getElementById('gframe');
            const loadingScreen = document.getElementById('loadingScreen');
            const currentSrc = iframe.src;
            
            // Reset state variables
            loadingAttempts = 0;
            analyticsErrorHandled = false;
            gameLoaded = false;
            
            loadingScreen.style.opacity = '1';
            loadingScreen.style.visibility = 'visible';
            iframe.style.opacity = '0';
            
            // Try with cache buster
            const cacheBuster = Date.now();
            const srcWithoutCache = currentSrc.split('?')[0];
            const newSrc = srcWithoutCache + '?cache=' + cacheBuster;
            
            // Set to blank first to ensure a complete reload
            iframe.src = 'about:blank';
            
            // Small delay before reloading
            setTimeout(() => {
                iframe.src = newSrc;
            }, 500);
        }

        function toggleFullScreen() {
            const gameContainer = document.querySelector('.game_container');
            const iframe = document.getElementById('gframe');
            const target = iframe; // Target the iframe for fullscreen
            
            try {
                if (!document.fullscreenElement && 
                    !document.webkitFullscreenElement && 
                    !document.msFullscreenElement) {
                    
                    // Try different fullscreen methods
                    if (target.requestFullscreen) {
                        target.requestFullscreen();
                    } else if (target.webkitRequestFullscreen) {
                        target.webkitRequestFullscreen();
                    } else if (target.msRequestFullscreen) {
                        target.msRequestFullscreen();
                    } else if (target.mozRequestFullScreen) {
                        target.mozRequestFullScreen();
                    }
                    
                    // Also try to make the iframe request fullscreen internally
                    try {
                        iframe.contentWindow.postMessage('requestFullscreen', '*');
                    } catch (e) {
                        // Ignore cross-origin errors
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    }
                }
            } catch (err) {
                console.error('Fullscreen error:', err);
                alert('Fullscreen mode is not supported in your browser or for this game');
            }
        }

        // Flashlight feature - toggles a dimmer overlay
        function toggleFlashlight() {
            let dimmer = document.getElementById('dimmer');
            
            if (!dimmer) {
                // Create the dimmer if it doesn't exist
                dimmer = document.createElement('div');
                dimmer.id = 'dimmer';
                dimmer.style.position = 'fixed';
                dimmer.style.top = '0';
                dimmer.style.left = '0';
                dimmer.style.width = '100%';
                dimmer.style.height = '100%';
                dimmer.style.background = 'rgba(0, 0, 0, 0.7)';
                dimmer.style.zIndex = '1';
                dimmer.style.transition = 'opacity 0.3s ease';
                document.body.appendChild(dimmer);
            } else {
                // Toggle visibility
                dimmer.style.display = dimmer.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Chat feature placeholder
        function toggleChat() {
            alert('Chat feature coming soon!');
        }
    </script>
    

    <script src="/assets/js/favicon-handler.js" defer></script>
</body>
</html>
