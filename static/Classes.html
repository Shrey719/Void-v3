<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classes</title>
    <!-- Preload critical resources -->
    <link rel="preload" as="image" href="/nav/home.png" fetchpriority="high">
    <link rel="preload" as="image" href="/nav/search.png" fetchpriority="high">
    <link rel="preload" as="image" href="/nav/apps.png" fetchpriority="high">
    
    <!-- Keep existing CSS unchanged -->
    <style>
        /* Your existing CSS remains exactly the same */
    </style>
</head>
<body>
    <!-- Keep existing HTML structure unchanged -->
    <header class="header">
        <!-- Your existing header content remains the same -->
    </header>

    <div class="game_container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
        <iframe class="game_iframe" id="gframe" allow="fullscreen; autoplay; keyboard"></iframe>
        <div class="footer">
            <!-- Your existing footer content remains the same -->
        </div>
    </div>

    <script>
        // Enhanced GameLoader with performance optimizations
        class GameLoader {
            constructor() {
                this.gameUrl = localStorage.getItem('loadedG');
                this.loadingTimeout = null;
                this.retryAttempts = 0;
                this.maxRetries = 3;
                this.loadStartTime = 0;
                this.iframe = document.getElementById('gframe');
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.initialize();
            }

            initialize() {
                if (!this.gameUrl) return;

                // Clear any existing load state
                sessionStorage.removeItem('gameLoaded');
                
                // Set up enhanced error handling and loading management
                this.setupEventListeners();
                
                // Start loading process
                this.startLoading();
            }

            setupEventListeners() {
                // Use passive listeners for better performance
                this.iframe.addEventListener('load', () => this.handleGameLoad(), { passive: true });
                this.iframe.addEventListener('error', () => this.handleLoadError(), { passive: true });
                
                // Add visibility change handling for better resource management
                document.addEventListener('visibilitychange', () => this.handleVisibilityChange(), { passive: true });
            }

            startLoading() {
                this.loadStartTime = performance.now();
                this.loadingOverlay.style.display = 'flex';

                // Set up loading timeout with exponential backoff
                const timeoutDuration = Math.min(15000 * (this.retryAttempts + 1), 30000);
                this.loadingTimeout = setTimeout(() => this.handleLoadingTimeout(), timeoutDuration);

                // Implement progressive loading
                this.preloadGame();
            }

            preloadGame() {
                // Create a lightweight preload check
                const preloadCheck = new Image();
                preloadCheck.onload = () => {
                    // If preload succeeds, load the actual game
                    this.loadGame();
                };
                preloadCheck.onerror = () => {
                    // If preload fails, try direct loading
                    this.loadGame();
                };
                preloadCheck.src = this.gameUrl;
            }

            loadGame() {
                // Implement a loading queue to prevent race conditions
                if (this.iframe.src === this.gameUrl) return;
                
                requestAnimationFrame(() => {
                    this.iframe.src = this.gameUrl;
                });
            }

            handleGameLoad() {
                const loadTime = performance.now() - this.loadStartTime;
                clearTimeout(this.loadingTimeout);
                
                // Reset retry counter on successful load
                this.retryAttempts = 0;
                
                // Implement progressive enhancement
                requestAnimationFrame(() => {
                    this.loadingOverlay.style.display = 'none';
                    document.title = 'Classes';
                    sessionStorage.setItem('gameLoaded', 'true');
                    sessionStorage.setItem('lastLoadTime', loadTime.toString());
                });
            }

            handleLoadError() {
                clearTimeout(this.loadingTimeout);
                
                if (this.retryAttempts < this.maxRetries) {
                    this.retryAttempts++;
                    this.startLoading();
                } else {
                    this.loadingOverlay.style.display = 'none';
                    console.error('Game failed to load after maximum retries');
                }
            }

            handleLoadingTimeout() {
                if (this.retryAttempts < this.maxRetries) {
                    this.retryAttempts++;
                    this.reloadGame();
                } else {
                    this.loadingOverlay.style.display = 'none';
                    console.warn('Game load timed out after maximum retries');
                }
            }

            handleVisibilityChange() {
                if (document.hidden) {
                    // Pause loading processes when tab is not visible
                    clearTimeout(this.loadingTimeout);
                } else {
                    // Resume loading if necessary
                    if (this.loadingOverlay.style.display === 'flex') {
                        this.startLoading();
                    }
                }
            }

            reloadGame() {
                this.loadingOverlay.style.display = 'flex';
                const currentSrc = this.iframe.src;
                
                // Implement proper cleanup before reload
                this.iframe.src = 'about:blank';
                
                // Use requestAnimationFrame for smoother reload
                requestAnimationFrame(() => {
                    if (currentSrc) {
                        this.gameUrl = currentSrc;
                        this.startLoading();
                    }
                });
            }
        }

        // Initialize game loader
        const gameLoader = new GameLoader();

        // Optimize existing functions
        function toggleFullScreen() {
            try {
                const container = document.querySelector('.game_container');
                if (!document.fullscreenElement) {
                    container.requestFullscreen().catch(console.warn);
                } else {
                    document.exitFullscreen().catch(console.warn);
                }
            } catch (err) {
                console.warn('Fullscreen error:', err);
            }
        }

        function reloadGame() {
            gameLoader.reloadGame();
        }

        // Defer keyboard shortcut initialization
        window.addEventListener('load', () => {
            document.addEventListener('keydown', e => {
                if (e.ctrlKey && e.key === '.') {
                    window.open('https://classroom.google.com', '_blank');
                }
            }, { passive: true });
        });
    </script>
</body>
</html>