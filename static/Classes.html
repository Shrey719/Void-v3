<!DOCTYPE html>
<html>
<head>
    <!-- Previous head content remains the same -->
    <style>
        /* Previous styles remain the same */

        /* Updated Ad Container Styles */
        #adContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            background-color: #000000;
            display: none;
        }

        #adVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000000;
        }

        #closeAdButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
            z-index: 2001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Previous body content remains the same until the script section -->

    <script>
        // Previous game-related functions remain the same

        // Updated VAST Ad Handler Implementation
        class VastAdHandler {
            constructor() {
                this.adContainer = null;
                this.videoPlayer = null;
                this.vastUrl = 'https://sophisticatedappearance.com/dVm/FNz/d.GgNZvPZBG/UB/TeymR9/ueZXUFl/k/PtTwUk3GN/DCkAxjOMT/UNtbN/TNcw0uOTTdEG5rNFiiZ/sPaBWj1ApqdEDi0fxQ';
                this.isAdPlaying = false;
            }

            initialize() {
                // Create ad container with black background
                this.adContainer = document.createElement('div');
                this.adContainer.id = 'adContainer';
                document.body.appendChild(this.adContainer);

                // Create video element
                this.videoPlayer = document.createElement('video');
                this.videoPlayer.id = 'adVideo';
                this.videoPlayer.setAttribute('playsinline', '');
                this.videoPlayer.setAttribute('webkit-playsinline', '');
                this.videoPlayer.muted = false; // Start unmuted
                this.videoPlayer.volume = 1; // Full volume
                this.adContainer.appendChild(this.videoPlayer);

                // Add close button
                const closeButton = document.createElement('button');
                closeButton.id = 'closeAdButton';
                closeButton.innerHTML = 'Ã—';
                closeButton.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.closeAd();
                };
                this.adContainer.appendChild(closeButton);

                // Handle video end
                this.videoPlayer.addEventListener('ended', () => {
                    this.closeAd();
                });
            }

            async loadVastXml() {
                try {
                    const response = await fetch(this.vastUrl);
                    const vastXml = await response.text();
                    const parser = new DOMParser();
                    return parser.parseFromString(vastXml, 'text/xml');
                } catch (error) {
                    console.error('Error loading VAST XML:', error);
                    return null;
                }
            }

            getMediaFiles(xmlDoc) {
                const mediaFiles = xmlDoc.getElementsByTagName('MediaFile');
                const sources = [];
                
                for (let mediaFile of mediaFiles) {
                    const type = mediaFile.getAttribute('type');
                    const url = mediaFile.textContent.trim();
                    if (url && !url.includes('undefined')) {
                        sources.push({ type, url });
                    }
                }
                
                return sources;
            }

            trackImpression(xmlDoc) {
                const impressionUrls = xmlDoc.getElementsByTagName('Impression');
                for (let impression of impressionUrls) {
                    const url = impression.textContent.trim();
                    if (url && !url.includes('undefined')) {
                        new Image().src = url;
                    }
                }
            }

            trackEvent(xmlDoc, eventName) {
                const trackingEvents = xmlDoc.getElementsByTagName('Tracking');
                for (let event of trackingEvents) {
                    if (event.getAttribute('event') === eventName) {
                        const url = event.textContent.trim();
                        if (url && !url.includes('undefined')) {
                            new Image().src = url;
                        }
                    }
                }
            }

            handleClick(xmlDoc) {
                const clickThrough = xmlDoc.getElementsByTagName('ClickThrough')[0];
                if (clickThrough) {
                    const url = clickThrough.textContent.trim();
                    if (url && !url.includes('undefined')) {
                        window.open(url, '_blank');
                    }
                }
            }

            closeAd() {
                // Remove the container completely instead of just hiding it
                if (this.adContainer && this.adContainer.parentNode) {
                    this.videoPlayer.pause();
                    this.adContainer.parentNode.removeChild(this.adContainer);
                    this.isAdPlaying = false;
                    // Reinitialize for next ad
                    this.initialize();
                }
            }

            async playAd() {
                if (this.isAdPlaying) return;

                const vastXml = await this.loadVastXml();
                if (!vastXml) return;

                const mediaFiles = this.getMediaFiles(vastXml);
                if (mediaFiles.length === 0) return;

                // Prefer MP4 format
                const mp4Source = mediaFiles.find(file => file.type === 'video/mp4');
                const sourceToUse = mp4Source || mediaFiles[0];

                // Clear and set source
                this.videoPlayer.innerHTML = '';
                const source = document.createElement('source');
                source.type = sourceToUse.type;
                source.src = sourceToUse.url;
                this.videoPlayer.appendChild(source);

                // Show container
                this.adContainer.style.display = 'block';
                this.isAdPlaying = true;

                // Track impression
                this.trackImpression(vastXml);

                // Set up click handling
                this.videoPlayer.onclick = () => this.handleClick(vastXml);
                
                // Force video load
                this.videoPlayer.load();

                // Attempt to play immediately
                try {
                    const playPromise = this.videoPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error('Autoplay failed:', error);
                            // If autoplay fails, try again with user interaction
                            const playButton = document.createElement('button');
                            playButton.textContent = 'Play';
                            playButton.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; font-size: 20px; cursor: pointer; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 5px;';
                            playButton.onclick = () => {
                                this.videoPlayer.play();
                                playButton.remove();
                            };
                            this.adContainer.appendChild(playButton);
                        });
                    }
                } catch (error) {
                    console.error('Play failed:', error);
                }
            }
        }

        // Initialize VAST Ad Handler
        const vastAdHandler = new VastAdHandler();

        // Load external resources after main content
        window.addEventListener('load', () => {
            // Initialize ad handler
            vastAdHandler.initialize();
            
            // Auto-play ad immediately
            vastAdHandler.playAd();

            // Previous event listeners remain the same
        });
    </script>
</body>
</html>
